Implement better tests. For all I know, large parts of this are horribly broken.

For more, see TODO comments in individual files.
